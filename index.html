<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <script src="./JiraAPI.js"></script>
    <script>
	
	// async function getCardDataFromJira(issueKey) {
	// 	const fields = await JiraAPI.getBasicInfo(issueKey);
		
	// 	return {
	// 		title: fields.summary, 
	// 		clientVisible: true,
	// 		card: {"customFields":[
	// 			{"value":fields.status.name,"tooltip":"Status","fieldType":"string","fontColor":"#ffffff","mainColor":"#205081"},
	// 			{"value":issueKey,"iconUrl":fields.issuetype.iconUrl,"tooltip":"Jira issue ("+fields.issuetype.name+")","fieldType":"string"},
	// 			{"value":"","iconUrl": fields.priority.iconUrl,"tooltip":fields.priority.name,"fieldType":"string"},
	// 			{"value":fields.assignee==null?'undefined':fields.assignee.name,"iconUrl":fields.assignee==null?"":fields.assignee.avatarUrl,"tooltip":"Assignee","fieldType":"string","roundedIcon":true}] }
	// 	};
		
	// }
	
	async function syncCardData(appIdKey, widget) {
		const issueKey = widget.metadata[appIdKey].issueKey;
		const cardData = await JiraAPI.getCardDataFromJira(issueKey);
		await miro.board.widgets.update({...{id: widget.id}, ...cardData});
	}

    miro.onReady(async () => {
		const appId = await miro.getClientId();
		const appIdKey = appId.toString();
				  
		miro.initialize({
			extensionPoints: 
			{
				getWidgetMenuItems: function (selectedWidgets) {
					const firstWidget = selectedWidgets[0];
					if (firstWidget.metadata && firstWidget.metadata[appIdKey] && firstWidget.metadata[appIdKey].linkTo === 'jira') {
					return [
						{
						tooltip: "Tooltip message",
						svgIcon:
							'<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
						onClick: () => {
							// miro.showNotification("You clicked a widget menu item!");
							miro.board.ui.openModal("security-details.html", { "max-height": "80%", "min-height": "40%", paddingTop: "20px", "padding-bottom": "20px" });
						},
						},
					];
					}
					return [];
				},
				bottomBar: {
					title: 'Add jira issue',
					svgIcon: '<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
					onClick: async () => {
						// miro.board.ui.openLibrary('add-issue-modal.html', {title: 'Select Jira Issue'})
						let issueKey = prompt("Please enter the issue key");
						const cardData = await JiraAPI.getCardDataFromJira(issueKey);
						miro.board.widgets.create({...{type: 'card', metadata:{[appId]: {linkTo: 'jira', issueKey: issueKey}}}, ...cardData});
					}
				},
				toolbar: {
					title: 'Add Jira Issue',
					toolbarSvgIcon: `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M27 7H5C3.89543 7 3 7.89543 3 9V23C3 24.1046 3.89543 25 5 25H15V27H12C11.4477 27 11 27.4477 11 28C11 28.5523 11.4477 29 12 29H15H17H20C20.5523 29 21 28.5523 21 28C21 27.4477 20.5523 27 20 27H17V25H27C28.1046 25 29 24.1046 29 23V9C29 7.89543 28.1046 7 27 7ZM17 23H27V9H5V23H15H17Z" fill="#050038"/>
</svg>`,
					librarySvgIcon: `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M27 7H5C3.89543 7 3 7.89543 3 9V23C3 24.1046 3.89543 25 5 25H15V27H12C11.4477 27 11 27.4477 11 28C11 28.5523 11.4477 29 12 29H15H17H20C20.5523 29 21 28.5523 21 28C21 27.4477 20.5523 27 20 27H17V25H27C28.1046 25 29 24.1046 29 23V9C29 7.89543 28.1046 7 27 7ZM17 23H27V9H5V23H15H17Z" fill="#050038"/>
</svg>`,
					onClick: async () => {
						miro.board.ui.openLibrary('add-issue-modal.html', {title: 'Select Jira Issue', height: '300px', width:'400px'})
						// let issueKey = prompt("Please enter the issue key");
						// const cardData = await JiraAPI.getCardDataFromJira(issueKey);
						// miro.board.widgets.create({...{type: 'card', metadata:{[appId]: {linkTo: 'jira', issueKey: issueKey}}}, ...cardData});
					}
				}
			}
		});
	  
		let refresh = async () => {
			let result = await miro.board.widgets.get().then(res=>res.filter(w=>w.metadata && w.metadata[appIdKey] && w.metadata[appIdKey].linkTo === 'jira'));
			let syncPromises = [];
			result.forEach(async (w)=>{
				syncPromises.push(syncCardData(appIdKey, w));
			});
			//Promise.all(syncPromises).then(()=>	alert('done with refresh'));
		}
		
		async function onAllWidgetsLoaded(callback) {
		  const areAllWidgetsLoaded = await miro.board.widgets.areAllWidgetsLoaded()
		  if (areAllWidgetsLoaded) {
			callback()
		  } else {
			miro.addListener('ALL_WIDGETS_LOADED', callback)
		  }
		}

		onAllWidgetsLoaded(async () => {
			miro.showNotification("Started syncing jira data!");
			await refresh();
			miro.showNotification("Finished syncing jira data!");
		})

		// miro.addListener('SELECTION_UPDATED', (event)=>{
		// 	miro.showNotification("You clicked a widget!");
		// 	console.log('SELECTION_UPDATED'+JSON.stringify(event));
		// })

		// miro.addListener('WIDGETS_CREATED', widget => {
		//   console.log('WIDGETS_CREATED'+widget);
		//   syncCardData(appIdKey, widget);
		// })

		// miro.addListener('DATA_BROADCASTED', (event)=>{
		// 	miro.showNotification("Data was broadcasted: "+JSON.stringify(event));
		// 	console.log('DATA_BROADCASTED'+JSON.stringify(event));
		// })

		// miro.addListener('CANVAS_CLICKED', (event)=>{
		// 	miro.showNotification("canvas was clicked: "+JSON.stringify(event));
		// 	console.log('CANVAS_CLICKED'+JSON.stringify(event));
		// })
		
		// For ALL_WIDGETS_LOADED event we need to check if widgets
		// are already loaded before subscription
    })
    </script>
</head>
</html>