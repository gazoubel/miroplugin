<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://miro.com/app/static/sdk.1.1.js"></script>
    <script>
	
	function getRandomInt(max) {
	  return Math.floor(Math.random() * Math.floor(max));
	}
	
	async function getCardDataFromJira(issueKey, widgetId) {
		//cosnt issueKey = widget.metadata[appIdKey].issueKey;
		const randomValue = getRandomInt(15);
		const isEvenMinutes = new Date().getMinutes() % 2 ===0;
		const shouldDisplay =  !issueKey.includes('SECURITY') || isEvenMinutes;
		return {
			id: widgetId, 
			title: 'This is the jira title '+randomValue, 
			clientVisible: shouldDisplay,
			card: {"customFields":[{"value":"To Do"+randomValue,"tooltip":"Status"+randomValue,"fieldType":"string","fontColor":"#ffffff","mainColor":"#205081"},{"value":issueKey,"iconUrl":"/api/v1/accounts/3074457349429795394/integrations/jira/resource?url=https%3A//citrixmiropoc.atlassian.net/secure/viewavatar?size%3Dmedium%26avatarId%3D10318%26avatarType%3Dissuetype","tooltip":"Issue type, Issue key","fieldType":"string"},{"value":"","iconUrl": "/api/v1/accounts/3074457349429795394/integrations/jira/resource?url=http://localhost:2990/images/icons/priorities/highest.svg","tooltip":"Priority","fieldType":"string"},{"value":"Andrew Roberts"+randomValue,"iconUrl":"/api/v1/accounts/3074457349429795394/integrations/jira/resource?url=https%3A//secure.gravatar.com/avatar/5459fec6b32b5b84b48b91a6fd1c92e7?d%3Dhttps%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FAR-6.png","tooltip":"Assignee","fieldType":"string","roundedIcon":true}] }
		};
		
	}
	
	async function syncCardData(appIdKey, widget) {
		const issueKey = widget.metadata[appIdKey].issueKey;
		const cardData = await getCardDataFromJira(issueKey, widget.id);
		//alert(JSON.stringify(cardData));
		await miro.board.widgets.update(cardData);
	}

    miro.onReady(async () => {
	
		const appId = await miro.getClientId();
		const appIdKey = appId.toString();
		
				  
		miro.initialize({
			extensionPoints: {
			  bottomBar: {
				title: 'Some title',
				svgIcon: '<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>',
				onClick: async () => {
				
				  alert('Hi with key!'+appIdKey);
				  let issueKey = prompt("Please enter the issue key");
				  miro.board.widgets.create({type: 'card', title: issueKey, metadata:{[appId]: {linkTo: 'jira', issueKey: issueKey}}});
				  
				  //miro.board.widgets.create({type: 'card', title: issueKey, metadata:{[appId]: {linkTo: 'jira', issueKey: issueKey}}, card: {"customFields":[{"value":"To Do","tooltip":"Status","fieldType":"string","fontColor":"#ffffff","mainColor":"#205081"},{"value":"MIRO-4","iconUrl":"/api/v1/accounts/3074457349429795394/integrations/jira/resource?url=https%3A//citrixmiropoc.atlassian.net/secure/viewavatar?size%3Dmedium%26avatarId%3D10318%26avatarType%3Dissuetype","tooltip":"Issue type, Issue key","fieldType":"string"},{"value":"","iconUrl": "/api/v1/accounts/3074457349429795394/integrations/jira/resource?url=http://localhost:2990/images/icons/priorities/highest.svg","tooltip":"Priority","fieldType":"string"},{"value":"Andrew Roberts","iconUrl":"/api/v1/accounts/3074457349429795394/integrations/jira/resource?url=https%3A//secure.gravatar.com/avatar/5459fec6b32b5b84b48b91a6fd1c92e7?d%3Dhttps%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FAR-6.png","tooltip":"Assignee","fieldType":"string","roundedIcon":true}] }});
				}
			  }
			}
		});
	  
		let refresh = async () => {
			let result = await miro.board.widgets.get().then(res=>res.filter(w=>w.metadata && w.metadata[appIdKey] && w.metadata[appIdKey].linkTo === 'jira'));
			let syncPromises = [];
			result.forEach(async (w)=>{
				syncPromises.push(syncCardData(appIdKey, w));
				//await syncCardData(appIdKey, w);
				//await miro.board.widgets.update({id: w.id, title: 'From Jira: '+w.metadata[appIdKey].issueKey, clientVisible: w.metadata[appIdKey].issueKey==='hide'?false:true});
			});
			//alert(JSON.stringify(result));
			Promise.all(syncPromises).then(()=>	alert('done with refresh'));
		}

		miro.addListener('WIDGETS_CREATED', widget => {
		  console.log('WIDGETS_CREATED'+widget);
		  syncCardData(appIdKey, widget);
		})

		// For ALL_WIDGETS_LOADED event we need to check if widgets
		// are already loaded before subscription
		async function onAllWidgetsLoaded(callback) {
		  const areAllWidgetsLoaded = await miro.board.widgets.areAllWidgetsLoaded()
		  if (areAllWidgetsLoaded) {
			callback()
		  } else {
			miro.addListener('ALL_WIDGETS_LOADED', callback)
		  }
		}

		onAllWidgetsLoaded(async () => {
			console.log('all widgets are loaded');
			let result = await miro.board.widgets.get().then(res=>res.filter(w=>w.metadata && w.metadata[appIdKey] && w.metadata[appIdKey].linkTo === 'jira'));
			result.forEach(async (w)=>{
				await miro.board.widgets.update({id: w.id, clientVisible: false});
			});
			console.log('all widgets are hiden');
			await refresh();
		})
    })
    </script>
</head>
</html>